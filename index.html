<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Posts App</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 20px auto; }
    h1 { text-align: center; }
    form, section { margin-bottom: 20px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
    label { display: block; margin: 6px 0; }
    input[type="text"], textarea, input[type="number"] { width: 100%; padding: 6px; box-sizing: border-box; }
    button { margin-top: 8px; padding: 6px 12px; }
    .post { border-bottom: 1px solid #ddd; padding: 8px 0; }
    .post:last-child { border-bottom: none; }
    .post-header { font-weight: bold; }
    .post-user { color: #555; font-size: 0.9em; }
    .post-content { margin: 6px 0; }

    .generated { margin-top: 6px; padding: 8px; border-left: 3px solid #999; background: #f7f7f7; }
    .generated-title { font-size: 0.9em; color: #444; font-weight: bold; margin-bottom: 4px; }

    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .toolbar button { margin-top:0; }

    .thumb { max-width: 180px; max-height: 180px; cursor: pointer; border: 1px solid #ccc; }
    .hint { color: #666; font-size: 0.85em; margin-top: 4px; }
    .error { color: #c00; font-weight: bold; }
  </style>
</head>
<body>
  <h1>Posts App</h1>

  <!-- a. Submit a post -->
  <section>
    <h2>Beitrag erstellen</h2>
    <form id="post-form">
      <label>
        Vorname:
        <input type="text" id="firstName" required />
      </label>
      <label>
        Nachname:
        <input type="text" id="lastName" required />
      </label>

      <!-- Datei-Upload -->
      <label>
        Bild-Datei:
        <input type="file" id="imageFile" accept="image/*" />
      </label>

      <label>
        Text:
        <textarea id="text" rows="4" required></textarea>
      </label>
      <button type="submit">Absenden</button>
    </form>
    <div id="post-result"></div>
  </section>

  <section>
    <h2>Beiträge eines Users suchen</h2>
    <label>
      Vorname:
      <input type="text" id="searchFirstName" />
    </label>
    <label>
      Nachname:
      <input type="text" id="searchLastName" />
    </label>
    <button id="searchButton" type="button">Suchen</button>
    <button id="clearSearch" type="button">Zurücksetzen</button>
  </section>

  <!-- b. List all posts -->
  <section>
    <div class="toolbar">
      <h2 id="posts-title" style="margin:0;">Alle Beiträge</h2>
    </div>
    <div id="posts-container"></div>
  </section>

  <script>
    const API_BASE = 'http://127.0.0.1:8000';

    const form = document.getElementById('post-form');
    const postsContainer = document.getElementById('posts-container');
    const postsTitle = document.getElementById('posts-title');
    const searchFirstNameInput = document.getElementById('searchFirstName');
    const searchLastNameInput = document.getElementById('searchLastName');
    const searchButton = document.getElementById('searchButton');
    const clearButton = document.getElementById('clearSearch');

    const refreshButton = document.getElementById('refreshButton');

    // Keep track of what the user is currently viewing (all posts vs. one user)
    let currentView = { type: 'all' }; // or: { type:'user', first_name, last_name }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function renderPosts(list, subtitle = 'Alle Beiträge') {
      postsTitle.textContent = subtitle;
      postsContainer.innerHTML = '';
      if (!list || list.length === 0) {
        postsContainer.textContent = 'Keine Beiträge gefunden.';
        return;
      }

      list.forEach(post => {
        const div = document.createElement('div');
        div.className = 'post';

        const thumbUrl = post.image_thumb_url ? `${API_BASE}${post.image_thumb_url}` : '';
        const fullUrl  = post.image_full_url  ? `${API_BASE}${post.image_full_url}`  : '';

        const imageHtml = thumbUrl
          ? `
              <div>
                <img class="thumb" src="${thumbUrl}" alt="Thumbnail" title="Klicken für Full-Size" />
                <div class="hint">click to open Full-Size</div>
              </div>
            `
          : '';

        // Asynchron generierter GPT2-Text (kommt später vom Backend, wenn Worker fertig ist)
        const genHtml = post.generated_text
          ? `
              <div class="generated">
                <div class="generated-title">GPT2-Textvorschlag</div>
                <div class="post-content">${escapeHtml(post.generated_text)}</div>
              </div>
            `
          : `<div class="hint">GPT2-Text wird noch generiert …</div>`;

        div.innerHTML = `
          <div class="post-header">Post #${post.id}</div>
          <div class="post-user">User-ID: ${post.user_id}</div>
          <div class="post-content">${escapeHtml(post.text)}</div>
          ${imageHtml}
          ${genHtml}
        `;

        // Klick auf Thumbnail -> Full-Size in neuem Tab öffnen
        if (thumbUrl && fullUrl) {
          div.querySelector('img.thumb')?.addEventListener('click', () => {
            window.open(fullUrl, '_blank');
          });
        }

        postsContainer.appendChild(div);
      });
    }

    async function loadAllPosts() {
      try {
        const response = await fetch(`${API_BASE}/posts`);
        if (!response.ok) throw new Error();
        const posts = await response.json();
        renderPosts(posts, 'Alle Beiträge');
      } catch {
        postsContainer.textContent = 'Fehler beim Laden der Beiträge.';
      }
    }

    async function refreshCurrentView() {
      if (currentView.type === 'user') {
        const params = new URLSearchParams({
          first_name: currentView.first_name,
          last_name: currentView.last_name
        });
        const response = await fetch(`${API_BASE}/user/by-name?${params.toString()}`);
        if (!response.ok) throw new Error();
        const user = await response.json();
        renderPosts(
          user.posts,
          `Beiträge von "${user.first_name} ${user.last_name}" (ID: ${user.id})`
        );
        return;
      }
      await loadAllPosts();
    }

    // a. Submit a post: 1) create user, 2) create post (multipart upload)
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const text = document.getElementById('text').value.trim();
      const fileInput = document.getElementById('imageFile');
      const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;

      if (!firstName || !lastName || !text) return;

      try {
        // 1) create user
        const userResponse = await fetch(`${API_BASE}/user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ first_name: firstName, last_name: lastName })
        });
        if (!userResponse.ok) throw new Error();
        const user = await userResponse.json();

        // 2) create post (multipart/form-data)
        const fd = new FormData();
        if (file) fd.append('file', file);
        fd.append('text', text);
        fd.append('user_id', String(user.id));

        const postResponse = await fetch(`${API_BASE}/post`, {
          method: 'POST',
          body: fd
        });
        if (!postResponse.ok) throw new Error();
        const post = await postResponse.json();

        // Reset form
        form.reset();

        currentView = { type: 'all' };
        await loadAllPosts();
      } catch (err) {
        document.getElementById('post-result').innerHTML =
          `<div class="error">Fehler beim Absenden des Beitrags.</div>`;
      }
    });

    // c. Find posts from one user by name
    searchButton.addEventListener('click', async () => {
      const firstName = searchFirstNameInput.value.trim();
      const lastName = searchLastNameInput.value.trim();
      if (!firstName || !lastName) {
        currentView = { type: 'all' };
        await loadAllPosts();
        return;
      }
      try {
        const params = new URLSearchParams({
          first_name: firstName,
          last_name: lastName
        });
        const response = await fetch(`${API_BASE}/user/by-name?${params.toString()}`);
        if (!response.ok) throw new Error();
        const user = await response.json();

        currentView = { type: 'user', first_name: firstName, last_name: lastName };

        renderPosts(
          user.posts,
          `Beiträge von "${user.first_name} ${user.last_name}" (ID: ${user.id})`
        );
      } catch {
        postsContainer.textContent = 'Fehler beim Laden der Benutzer-Beiträge.';
      }
    });

    clearButton.addEventListener('click', async () => {
      searchFirstNameInput.value = '';
      searchLastNameInput.value = '';
      currentView = { type: 'all' };
      await loadAllPosts();
    });

    refreshButton.addEventListener('click', async () => {
      try {
        await refreshCurrentView();
      } catch {
        // ignore
      }
    });

    // Auto-refresh every 5s so async jobs (thumbnail + GPT2 text) show up without manual reload
    setInterval(() => {
      refreshCurrentView().catch(() => {});
    }, 5000);

    // initial load
    loadAllPosts();
  </script>
</body>
</html>
